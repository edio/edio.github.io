<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <title>
    Turning Synology NAS into a geeky media server | 127.0.0.1
  </title>

  
  <meta name="viewport" content="width=device-width,user-scalable=yes,maximum-scale=1.5,initial-scale=1">

  
  <link rel="canonical" href="http://127001.me/post/synology/mediaserver-p1/"/>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon144.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/hljs/atelier-heath-light.css">
  <link rel="stylesheet" href="/css/theme.css">

  
  <link href="http://127001.me/index.xml" rel="alternate" type="application/rss+xml" title="127.0.0.1"/>
  <link href="http://127001.me/index.xml" rel="feed" type="application/rss+xml" title="127.0.0.1"/>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-82090130-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>

<div class="container">
  <header role="banner">
    <div class="title-block">
      <span class="title-span">
        <a class="title" href="http://127001.me/">
          <span class="user">me</span>@<span class="host">127.0.0.1</span>:<span class="cwd">~</span><span class="prompt">$</span> <span class="cursor">_</span>
        </a>
        
          
        
      </span>
    </div>
  </header>


<main id="single" role="main">
  <div class="post-title-wrapper">
  <div style="display: flex">
    <div style="flex: 1">
<div class="post-category">
  <a href="/category/localhost">/localhost/</a>
</div>

</div>
    <div class="post-date">Jan 6, 2016</div>
  </div>
  <h1>Turning Synology NAS into a geeky media server </h1>
  <div style="display: flex">
    <div style="flex: 1">
<div class="post-tags-list">
  
  <a href="/tags/linux">#linux</a>&nbsp;
  
  <a href="/tags/synology-ds214">#synology ds214</a>&nbsp;
  
</div>

</div>
  </div>
</div>

  <article>
    <div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>UPDATE: This post was written in pre-docker era. Back in the time it was necessary to perform many things that are
no longer required on modern devices (like installing Debian Chroot package which, expectedly, is no longer offered).</p>
</div>
<div class="paragraph">
<p>Modern devices with Docker support or equivalent features (FWIW, my choice is Linux Station from QNAP) are much more
friendly towards linux enthusiasts</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Required files can be downloaded from <a href="https://github.com/edio/synology-mediaserver" class="bare">https://github.com/edio/synology-mediaserver</a></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>I&#8217;m not a huge fan of Synology. I bought my DS214 by friend&#8217;s recommendation and became frustrated with it right after
the purchase. Bundled software was limited and buggy. Many people find Synology products great. But for me it just
didn&#8217;t work well because it forced its use cases on me instead of being a helpful tool for my own very specific use
cases.</p>
</div>
<div class="paragraph">
<p>Anyway, I wasn&#8217;t willing to lose money on reselling my NAS, so I decided to get as much as possible from it and
currently with my DS214Play I can:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Play virtually any sound via connected USB sound card.</p>
</li>
<li>
<p>Particularly, I can play my huge collection of high-resolution music in various formats (with replaygain tags
respected). All that thanks to <em>mpd</em>, which I can control from any decent phone, web-browser or even smart-watch and
scrobble all statistics to Last.fm.</p>
</li>
<li>
<p>Stream sound from my laptop via <strong>PulseAudio</strong>, while watching videos on YouTube or movies.</p>
</li>
</ol>
</div>
<div id="cut" class="paragraph">
<p>In this and few next posts I&#8217;m going to tell, what I have done to get all this.</p>
</div>
<div class="paragraph">
<p>Although everything here have been tried on DS214Play it should also work on any other x86-based (or theoretically, even
on ARM-based) Synology product.</p>
</div>
<div class="paragraph">
<p>I do not expect anything bad, but, just in case, standard disclaimer: <strong>everything described here may contain mistakes
and inaccuracies, cause data loss or even damage to your hardware.</strong></p>
</div>
<div class="sect1">
<h2 id="_notations">Notations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code you need to execute in a terminal will be presented in code blocks, <code>$</code> prompt means, that code is to be
executed from an unprivileged user, <code>#</code> means that code must be executed from root. Environment will be given in braces
before the prompt. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Execute on NAS from an unprivileged user</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)$ date</code></pre>
</div>
</div>
</li>
<li>
<p>Execute as root in chroot</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(chroot)# date</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_debian_chroot">Setup Debian chroot</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We start with <a href="https://synocommunity.com/package/debian-chroot">Debian chroot</a> setup because it will help us a lot
during testing and it&#8217;ll be required for PulseAudio to work later.</p>
</div>
<div class="paragraph">
<p>Debian repositories contain thousands of applications, and unlike optware solutions all packages are relatively fresh
and usually work without issues.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add SynoCommunity repo following <a href="https://synocommunity.com/#easy-install">official guide</a>. Do not forget to set
Trust level to <strong>Synology Inc. and trusted publishers</strong></p>
</li>
<li>
<p>Install <a href="https://synocommunity.com/package/debian-chroot">Debian Chroot</a> package</p>
</li>
<li>
<p>Start this package from <strong>Package Center</strong></p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_configure_debian_chroot">Configure Debian chroot</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>SSH to NAS and <code>su</code> to <strong>root</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)$ sudo -s</code></pre>
</div>
</div>
</li>
<li>
<p>Chroot to Debian</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# /var/packages/debian-chroot/scripts/start-stop-status chroot</code></pre>
</div>
</div>
</li>
<li>
<p>Update package index and install locales to remove pesky warning about missing locales</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(chroot)# apt-get update
(chroot)# apt-get install locales-all</code></pre>
</div>
</div>
</li>
<li>
<p>Install alsa utils as we&#8217;ll require them later</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(chroot)# apt-get install alsa-utils</code></pre>
</div>
</div>
</li>
<li>
<p>Exit form chroot (or create another SSH session)</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(chroot)# exit</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_share_media_files_to_debian_chroot">Share media files to Debian chroot</h3>
<div class="paragraph">
<p>By default Debian chroot won&#8217;t get access to files stored on NAS (that&#8217;s the idea of chroot). We have to mount
explicitly those directories, we want to expose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# mount -o bind /path/to/dir/on/nas /var/packages/debian-chroot/target/var/chroottarget/path/to/dir/in/chroot</code></pre>
</div>
</div>
<div class="paragraph">
<p>I created a script under <code>/usr/local/etc/rc.d/</code> to do that mounting automatically on startup. The script must be named
<code>S[00-99]whatever.sh</code> to be picked up by DSM init framework, where <code>[00-99]</code> determines order of execution. Mine is
named <code>S90chrootmount.sh</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>#!/bin/sh

. /etc.defaults/rc.subr

CHROOTDIR=/var/packages/debian-chroot/target/var/chroottarget/media
MEDIADIR=/volume1/media

case $1 in
        start)
                mount -o bind $MEDIADIR $CHROOTDIR
        ;;
        stop)
                umount $CHROOTDIR
        ;;
        restart)
                $0 stop
                sleep 1
                $0 start
        ;;
        *)
                echo "Usage: $0 start|stop|restart"
        ;;
esac</code></pre>
</div>
</div>
<div class="paragraph">
<p>To expose directory to chroot then, do</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# /usr/local/etc/rc.d/S90chrootmount.sh start</code></pre>
</div>
</div>
<div class="paragraph">
<p>After doing that, we can chroot to Debian again and check that mount worked as expected (<code>/media</code> in chroot should
corresponds to <code>/volume1/media</code> on NAS for my case).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_sound_card">Setup sound card</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Obviously, sound card should be supported in Linux. I own <strong>Audinst USB HUD mini</strong> and it&#8217;s a real plug-n-play. I just
plug it in, and if alsa is set up, it just works. For what it&#8217;s worth, I&#8217;m satisfied with the device, it sounds not as
good as my beloved ESI Juli@, but still it is good for its price.</p>
</div>
<div class="sect2">
<h3 id="_loading_kernel_modules">Loading kernel modules</h3>
<div class="paragraph">
<p>For sound card to work we need to install required kernel modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>#!/bin/sh

. /etc.defaults/rc.subr

KERNELMODULE="soundcore snd-page-alloc snd snd-seq-device snd-rawmidi snd-usbmidi-lib snd-usb-lib snd-hwdep snd-timer snd-pcm snd-usb-audio snd-mixer-oss snd-pcm-oss"
COMPATMODULE="snd-usb-hiface"

case $1 in
        start)
                SYNOLoadModules $KERNELMODULE
                SYNOLoadModules $COMPATMODULE
        ;;
        stop)
                SYNOUnloadModules $COMPATMODULE
                SYNOUnloadModules $KERNELMODULE
        ;;
        restart)
                $0 stop
                sleep 1
                $0 start
        ;;
        *)
                echo "Usage: $0 start|stop|restart"
        ;;
esac</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will load exactly the modules, that are loaded by <strong>AudioStation</strong>.</p>
</div>
<div class="paragraph">
<p>To do that automatically on NAS startup I saved the script as <code>/usr/local/etc/rc.d/S01audiod.sh</code>.</p>
</div>
<div class="paragraph">
<p>Load modules without reboot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# /usr/local/etc/rc.d/S01audiod.sh start</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_verify_it_works">Verify it works</h3>
<div class="paragraph">
<p>Chroot to Debian chroot and test it with <code>aplay</code>. You&#8217;ll need some <code>*.wav</code> file in your media files</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# /var/packages/debian-chroot/scripts/start-stop-status chroot
(chroot)# aplay /media/path/to/some.wav</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it doesn&#8217;t work right ahead, examine output of <code>aplay -L</code>, maybe you need to choose a different device</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(chroot)# aplay -L
(chroot)# aplay -D front /media/path/to/some.wav</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fixing_permissions_issue">Fixing permissions issue</h3>
<div class="paragraph">
<p>By default sound device is initialized to be accessible only by root user. An easy temporary fix would be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# chmod a+rw /dev/dsp*
(nas)# chmod -R a+rw /dev/snd/</code></pre>
</div>
</div>
<div class="paragraph">
<p>But then, if device is replugged, you have to do that again. To fix that permanently we need an udev rule to set mode
each time device is connected.</p>
</div>
<div class="paragraph">
<p>Create <code>/usr/lib/udev/rules.d/50-sound.rules</code> with the following content</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>SUBSYSTEM=="sound", MODE="0666"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reload udev rules</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# udevadm control --reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reconnect sound card or use reload kernel modules</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>(nas)# /usr/local/etc/rc.d/S01audiod.sh restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see that newly created devices have <code>rw</code> mode for all users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ ls -l /dev/dsp*
crw-rw-rw- 1 root root 14, 67 Aug 15 16:44 /dev/dsp4

$ ls -l /dev/snd/*
crw-rw-rw- 1 root root 116,  0 Aug 15 16:44 /dev/snd/controlC0
crw-rw-rw- 1 root root 116, 16 Aug 15 17:38 /dev/snd/pcmC0D0p
crw-rw-rw- 1 root root 116, 17 Aug 15 16:44 /dev/snd/pcmC0D1p
crw-rw-rw- 1 root root 116, 33 Aug 15 16:44 /dev/snd/timer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now every user in <code>audio</code> group in Debian chroot will have access to audio device.</p>
</div>
<div class="paragraph">
<p>Basically that&#8217;s it. For more experienced users it shouldn&#8217;t be hard to setup <em>mpd</em> on Debian to play via ALSA.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re interested in sound streaming over network with PulseAudio, please check out the
<a href="/post/synology/mediaserver-p2">next part</a>.</p>
</div>
</div>
</div>
</div>
  </article>
</main>



<article class="comments">
    <div id="disqus_thread"></div>
    <script>
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) !== -1) {
          document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
        } else {
          var disqus_config = function () {
              
          };
          (function() {
              var inIFrame = function() {
                  var iframe = true;
                  try { iframe = window.self !== window.top; } catch (e) {}
                  return iframe;
              };
              if (inIFrame()) return;
              var disqus_js = '//127001me.disqus.com/embed.js';
              var d = document, s = d.createElement('script');
              s.src = disqus_js; s.async = true;
              s.setAttribute('data-timestamp', +new Date());
              var b = false, l = function() {
                  if (b) return;
                  (d.head || d.body).appendChild(s); b = true;
              }
              var t = d.getElementById('disqus_thread');
              s.onerror = function(e) {
                  if (sessionStorage.getItem('failure-note')) return;
                  t.innerText = 'Disqus failed to load';
                  t.style.border = '1px dashed';
                  t.style.padding = '.5em';
                  t.style.background = 'lightyellow';
                  sessionStorage.setItem('failure-note', true);
              };
              
              if (location.hash.match(/^#comment/)) return l();
              var c = function() {
                  if (b) return;
                  var rect = t.getBoundingClientRect();
                  if (rect.top < window.innerHeight && rect.bottom >= 0) l();
              };
              window.addEventListener('load', c);
              d.addEventListener('scroll', c);
          })();
        }
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</article>


<footer role="contentinfo">
  <div class="footer-content">
    
    <div class="footer-copyright-info">
      © 2016 Dmytro Kostiuchenko
    </div>
    

    <div class="footer-social-buttons">
      
      <a href="https://github.com/edio" title="GitHub"><i class="fa fa-github"></i></a>
      
      
      <a href="https://ua.linkedin.com/in/dmytro-kostiuchenko-7b046b14" title="Linkedin"><i class="fa fa-linkedin-square"></i></a>
      
      
      
      
    </div>
  </div>
</footer>
</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>


